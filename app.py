import streamlit as st
from supabase import create_client
from google.oauth2 import service_account
from googleapiclient.discovery import build
from googleapiclient.http import MediaIoBaseUpload
import time
import re
from datetime import datetime

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="Traffic Game", page_icon="üö¶", layout="centered")

# --- 2. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Session State ---
if 'page' not in st.session_state: st.session_state.page = 'login'
if 'user' not in st.session_state: st.session_state.user = None
if 'selected_mission' not in st.session_state: st.session_state.selected_mission = None

# --- 3. ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏î‡∏à‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡πà‡∏≤‡∏ô URL (‡∏Å‡∏±‡∏ô‡πÄ‡∏î‡πâ‡∏á) ---
if "page" in st.query_params:
    st.session_state.page = st.query_params["page"]
if "m_id" in st.query_params:
    st.session_state.selected_mission = int(st.query_params["m_id"])

# --- 4. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö (‡πÉ‡∏ä‡πâ secrets ‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà) ---
try:
    supabase = create_client(st.secrets["SUPABASE_URL"], st.secrets["SUPABASE_KEY"])
    gcp_info = dict(st.secrets["gcp_service_account"])
    gcp_info["private_key"] = gcp_info["private_key"].replace("\\n", "\n").strip()
    creds = service_account.Credentials.from_service_account_info(
        gcp_info, scopes=['https://www.googleapis.com/auth/drive.file']
    )
    drive_service = build('drive', 'v3', credentials=creds)
    DRIVE_FOLDER_ID = st.secrets["general"]["DRIVE_FOLDER_ID"]
except Exception as e:
    st.error("‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤")
    st.stop()

# ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô Session ‡∏à‡∏≤‡∏Å URL
if "u" in st.query_params and st.session_state.user is None:
    u_url = st.query_params["u"]
    try:
        user_res = supabase.table("users").select("*").eq("username", u_url).execute()
        if user_res.data:
            st.session_state.user = user_res.data[0]
    except:
        pass

# --- 5. CSS ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á (‡πÄ‡∏ô‡πâ‡∏ô‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ü‡πâ‡∏≤‡∏à‡∏¥‡πã‡∏ß ‡πÅ‡∏•‡∏∞‡∏ä‡∏¥‡∏î‡∏Å‡∏±‡∏ô) ---
st.markdown("""
    <style>
        .stApp { background-color: #f8f9fa !important; }
        
        /* üîµ ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° */
        div[data-testid="stFormSubmitButton"] > button {
            background-color: #1877f2 !important; color: white !important;
            font-weight: bold !important; height: 45px !important; border-radius: 10px !important;
        }

        /* üü¢ ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏£‡∏≠‡∏á */
        div.stButton > button[kind="secondary"] {
            background-color: #42b72a !important; color: white !important;
            font-weight: bold !important; height: 45px !important; border-radius: 10px !important;
        }

        /* üé® üõë ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏¥‡πã‡∏ß‡∏Å‡∏£‡∏≠‡∏ö‡∏ü‡πâ‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á) */
        .thin-btn-blue div.stButton > button {
            background-color: transparent !important;
            color: #1877f2 !important; /* ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡πÇ‡∏ó‡∏ô‡πÄ‡∏£‡∏≤ */
            border: 1px solid #1877f2 !important; /* ‡∏Å‡∏£‡∏≠‡∏ö‡∏ü‡πâ‡∏≤‡∏ö‡∏≤‡∏á 1px */
            padding: 0px 4px !important;
            height: 24px !important; /* ‡∏à‡∏¥‡πã‡∏ß‡∏•‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° */
            min-height: unset !important;
            font-size: 11px !important; /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏û‡∏¥‡πÄ‡∏®‡∏© */
            border-radius: 4px !important;
            width: auto !important;
            margin: 0 !important;
        }
        .thin-btn-blue div.stButton > button:hover {
            background-color: #1877f2 !important; color: white !important;
        }

        /* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤‡∏ï‡∏±‡∏ß‡∏à‡∏¥‡πã‡∏ß */
        .status-mini {
            font-size: 11px !important;
            line-height: 24px;
            text-align: right;
            font-weight: normal;
        }

        /* ‚ùå ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î */
        [data-testid="column"] {
            padding: 0px !important;
            margin: -8px 0px !important; 
        }
        
        hr { margin: 5px 0px !important; }
    </style>
""", unsafe_allow_html=True)

def go_to(page_name):
    u_val = st.query_params.get("u")
    st.query_params.clear()
    if u_val and page_name != 'login': st.query_params["u"] = u_val
    st.session_state.page = page_name
    st.session_state.selected_mission = None
    st.rerun()

# --- 6. ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ---

# üîµ ‡∏´‡∏ô‡πâ‡∏≤ LOGIN
if st.session_state.page == 'login':
    st.markdown("<h1 style='text-align: center; color:#1877f2;'>traffic game</h1>", unsafe_allow_html=True)
    _, col, _ = st.columns([1, 4, 1])
    with col:
        with st.form("login_form"):
            u_input = st.text_input("Username")
            p_input = st.text_input("Password", type="password")
            if st.form_submit_button("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö", use_container_width=True):
                res = supabase.table("users").select("*").eq("username", u_input).execute()
                if res.data and res.data[0]['password'] == p_input:
                    st.session_state.user = res.data[0]
                    st.query_params["u"] = u_input 
                    if st.session_state.user.get('role') == 'admin': go_to('admin_dashboard')
                    else: go_to('game')
                else: st.error("‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")
        if st.button("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà", use_container_width=True, type="secondary"): go_to('signup')

# üü¢ ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å / üîë ‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
elif st.session_state.page == 'signup':
    st.subheader("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å")
    # ... ‡∏™‡πà‡∏ß‡∏ô Signup ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà ...
    if st.button("‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö", type="secondary"): go_to('login')

# üéÆ ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (Player)
elif st.session_state.page == 'game':
    if st.session_state.user is None: go_to('login')
    u = st.session_state.user
    
    if st.session_state.selected_mission is None:
        st.markdown(f"**‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì {u['fullname']}**")
        st.write("---")
        
        missions = supabase.table("missions").select("*").eq("is_active", True).execute().data
        today = datetime.now().strftime("%Y-%m-%d")
        subs = supabase.table("submissions").select("mission_id").eq("user_username", u['username']).gte("created_at", today).execute().data
        done_ids = [s['mission_id'] for s in subs]

        # ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à
        for m in missions:
            is_done = m['id'] in done_ids
            # ‡πÅ‡∏ö‡πà‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 75:25
            c1, c2 = st.columns([0.75, 0.25])
            with c1:
                st.markdown('<div class="thin-btn-blue">', unsafe_allow_html=True)
                if st.button(f"üìç {m['title']}", key=f"m_{m['id']}"):
                    st.session_state.selected_mission = m['id']
                    st.rerun()
                st.markdown('</div>', unsafe_allow_html=True)
            with c2:
                col_s = "#42b72a" if is_done else "#888"
                txt_s = "‚úÖ ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß" if is_done else "‚≠ï ‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô"
                st.markdown(f'<div class="status-mini" style="color:{col_s};">{txt_s}</div>', unsafe_allow_html=True)
            
    else:
        # --- ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à ---
        m_id = st.session_state.selected_mission
        m_data = supabase.table("missions").select("*").eq("id", m_id).single().execute().data
        st.markdown(f"### {m_data['title']}")
        if st.button("‚¨ÖÔ∏è ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö", key="back"): st.session_state.selected_mission = None; st.rerun()
        
        f = st.file_uploader("üì∏ ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢", type=['jpg','png','jpeg'])
        if f and st.button("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô", type="secondary", use_container_width=True):
             # [‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°]
             st.success("üéâ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); time.sleep(1); st.session_state.selected_mission = None; st.rerun()

    st.write("---")
    if st.button("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö"): 
        st.session_state.user = None
        st.query_params.clear()
        go_to('login')

# üõ†Ô∏è Admin Dashboard
elif st.session_state.page == 'admin_dashboard':
    st.write("‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô")
    if st.button("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö"): go_to('login')
