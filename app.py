import streamlit as st
from supabase import create_client
import time

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="Traffic Game", page_icon="üö¶")

# --- 2. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase ---
try:
    url = st.secrets["SUPABASE_URL"]
    key = st.secrets["SUPABASE_KEY"]
    supabase = create_client(url, key)
except Exception as e:
    st.error("‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πá‡∏Ñ Secrets ‡∏î‡πà‡∏ß‡∏ô")
    st.stop()

# --- 3. CSS ‡πÅ‡∏ï‡πà‡∏á‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏° (‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á) ---
st.markdown("""
    <style>
        /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå */
        .block-container {
            max-width: 400px;
            padding-top: 2rem;
            margin: auto;
        }

        /* 1. ‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö" (Form Submit) -> ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏° */
        div[data-testid="stFormSubmitButton"] > button {
            background-color: #1877f2 !important;
            color: white !important;
            border: none !important;
            font-weight: bold !important;
            height: 45px !important;
            font-size: 16px !important;
            width: 100% !important;
            border-radius: 6px !important;
        }
        div[data-testid="stFormSubmitButton"] > button:hover {
            background-color: #166fe5 !important;
        }

        /* 2. ‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å" (Regular Button) -> ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
        div.stButton > button:not([kind="secondary"]) {
            background-color: #42b72a !important;
            color: white !important;
            border: none !important;
            font-weight: bold !important;
            height: 45px !important;
            font-size: 16px !important;
            width: 100% !important;
            border-radius: 6px !important;
            margin-top: 10px !important;
        }
        div.stButton > button:not([kind="secondary"]):hover {
            background-color: #36a420 !important;
        }

        /* 3. ‡∏õ‡∏∏‡πà‡∏° "‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" & "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" (Secondary) -> ‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏≤‡∏ß */
        div.stButton > button[kind="secondary"] {
            border: none !important;
            background: transparent !important;
            color: #1877f2 !important;
            font-size: 14px !important;
            height: auto !important;
            padding: 0 !important;
            margin-top: 5px !important;
            text-decoration: none !important;
        }
        div.stButton > button[kind="secondary"]:hover {
            color: #0d4f9e !important;
            text-decoration: underline !important;
        }
        
        /* ‡∏à‡∏±‡∏î Input ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
        input { text-align: center; }
        
        /* ‡∏ã‡πà‡∏≠‡∏ô‡∏•‡∏π‡∏Å‡∏ï‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô */
        button[aria-label="Show password"] { display: none !important; }
        
    </style>
""", unsafe_allow_html=True)

# --- 4. ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤ (State) ---
if 'page' not in st.session_state:
    st.session_state.page = 'login'

def go_to(page):
    st.session_state.page = page
    st.rerun()

# --- 5. Layout ---
col1, col2, col3 = st.columns([1, 10, 1]) # ‡∏ö‡∏µ‡∏ö‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÅ‡∏ô‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô

with col2:
    # ==========================================
    # üîµ ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠: ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Login)
    # ==========================================
    if st.session_state.page == 'login':
        st.markdown("<h1 style='text-align: center; color: #1877f2; margin-bottom: 0;'>traffic game</h1>", unsafe_allow_html=True)
        st.markdown("<p style='text-align: center; font-size: 20px; margin-top: 0;'>‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≠‡∏î</p>", unsafe_allow_html=True)
        
        # ‡∏Å‡∏•‡πà‡∏≠‡∏á Login (‡πÉ‡∏ä‡πâ Form ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏î Enter ‡πÑ‡∏î‡πâ)
        with st.form("login_form"):
            username = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", label_visibility="collapsed", placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ")
            password = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô", type="password", label_visibility="collapsed", placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô")
            
            # [‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏°]
            submitted = st.form_submit_button("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö")
            
            if submitted:
                # --- Login Logic ---
                try:
                    res = supabase.table("users").select("*").eq("username", username).execute()
                    if res.data:
                        user_data = res.data[0]
                        if user_data["password"] == password:
                            st.success(f"‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì {user_data['fullname']}")
                            # ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
                        else:
                            st.error("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")
                    else:
                        st.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ")
                except Exception as e:
                    st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")

        # [‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏•‡πà‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö]
        # ‡πÉ‡∏ä‡πâ columns ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏õ‡πä‡∏∞‡πÜ
        c1, c2, c3 = st.columns([1, 2, 1])
        with c2:
            if st.button("‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", type="secondary", use_container_width=True):
                go_to('forgot')

        st.markdown("---") # ‡πÄ‡∏™‡πâ‡∏ô‡∏Ñ‡∏±‡πà‡∏ô
        
        # [‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß]
        if st.button("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà", use_container_width=True):
            go_to('signup')

    # ==========================================
    # üü¢ ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠: ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (Signup)
    # ==========================================
    elif st.session_state.page == 'signup':
        st.markdown("<h2 style='text-align: center;'>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>", unsafe_allow_html=True)
        
        with st.form("signup_form"):
            reg_name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•", placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•")
            reg_user = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", placeholder="‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©/‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 6-12 ‡∏ï‡∏±‡∏ß")
            reg_phone = st.text_input("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå", placeholder="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 10 ‡∏´‡∏•‡∏±‡∏Å", max_chars=10)
            reg_pass = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô", type="password", placeholder="6-13 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£")
            reg_confirm = st.text_input("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô", type="password", placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô")
            
            # ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô Form ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏ï‡∏≤‡∏° CSS Submit (‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ CSS ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å)
            # ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Flow ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß ‡∏ú‡∏°‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ CSS Hack ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° Submit ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏î‡πâ‡∏ß‡∏¢
            st.markdown("""<style>div[data-testid="stFormSubmitButton"] > button { background-color: #42b72a !important; }</style>""", unsafe_allow_html=True)
            
            submitted = st.form_submit_button("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å")
            
            if submitted:
                # Validation & Supabase Insert (Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏µ‡πà‡∏ä‡∏≠‡∏ö)
                u_user = reg_user.strip()
                errors = []
                if not reg_name: errors.append("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•")
                if " " in u_user: errors.append("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ")
                if not (6 <= len(u_user) <= 12): errors.append("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á 6-12 ‡∏ï‡∏±‡∏ß")
                if len(reg_phone) != 10: errors.append("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡πâ‡∏≠‡∏á 10 ‡∏´‡∏•‡∏±‡∏Å")
                if not (6 <= len(reg_pass) <= 13): errors.append("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á 6-13 ‡∏ï‡∏±‡∏ß")
                if reg_pass != reg_confirm: errors.append("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô")

                if errors:
                    for err in errors: st.error(err)
                else:
                    try:
                        check = supabase.table("users").select("username").eq("username", u_user).execute()
                        if check.data:
                            st.error("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß")
                        else:
                            supabase.table("users").insert({
                                "fullname": reg_name, "username": u_user, "phone": reg_phone, "password": reg_pass
                            }).execute()
                            st.success("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
                            st.balloons()
                            time.sleep(2)
                            go_to('login')
                    except Exception as e:
                        st.error(f"Error: {e}")

        # ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö (‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏•‡πá‡∏Å)
        if st.button("‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß? ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö", type="secondary", use_container_width=True):
            go_to('login')

    # ==========================================
    # üü° ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠: ‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Forgot)
    # ==========================================
    elif st.session_state.page == 'forgot':
        st.markdown("<h3 style='text-align: center;'>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>", unsafe_allow_html=True)
        
        with st.form("forgot_form"):
            find_user = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ", placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ")
            submitted = st.form_submit_button("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤")
            
            if submitted:
                try:
                    res = supabase.table("users").select("password").eq("username", find_user).execute()
                    if res.data:
                        st.success(f"‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠: {res.data[0]['password']}")
                    else:
                        st.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö")
                except Exception as e:
                    st.error(f"Error: {e}")
        
        if st.button("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å", type="secondary", use_container_width=True):
            go_to('login')
